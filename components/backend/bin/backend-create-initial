#!/usr/bin/env python3

from typing import List
from datetime import datetime
from backend.data.db.results import RegistroSensor, Sensor
from backend.data.config import BackendConfiguration
from backend.data.db import Esquema
from backend.data.util import Sensor as SensorBackend
from backend.service import SensorService, RegistroSensorService, PlantaService, TipoPlantaService, SensorPlantaService
from common.data.util import TipoSensor, ZonaSensor, ModeloSensor, TipoMedida, UnidadMedida
from common.data.util import Planta as PlantaCommon, TipoPlanta as TipoPlantaCommon
from common.data.util import Sensor as SensorCommon, RegistroSensor as RegistroSensorCommon, SensorPlanta as SensorPlantaCommon

cfg: BackendConfiguration = BackendConfiguration()
#cfg.load_from_file(cfg.default_config_file())
db: Esquema = Esquema(cfg)

#datos de inicializacion del sistema
tipo_planta_ninguno = TipoPlantaService.create(db,"Ninguno","Sin descripcion")
planta_vacia = PlantaService.create(db,"Sin planta","Ninguno",None,None)

#datos de pruebas
sensor_humedad_ambiente_1 = SensorService.create(db,"HUMEDAD","AMBIENTE",1,"DHT11",patilla_0_lectura=19, unidad_medida_0=UnidadMedida.GRADOS_CENTIGRADOS)
sensor_temperatura_ambiente_1 = SensorBackend(TipoSensor.TEMPERATURA,ZonaSensor.AMBIENTE,1,"DHT11",patilla_0_lectura=19, unidad_medida_0=UnidadMedida.PORCENTAJE)
sensor_temperatura_ambiente_1 = SensorService.createFromCommon(db,sensor_temperatura_ambiente_1)

sensor_temperatura_y_humedad_ambiente_1 = SensorBackend(TipoSensor.TEMPERATURA_Y_HUMEDAD,ZonaSensor.AMBIENTE,1,"DHT11",patilla_0_lectura=21)
sensor_temperatura_y_humedad_ambiente_1 =SensorService.createFromCommon(db,sensor_temperatura_y_humedad_ambiente_1)

tipo_planta_tomatera = TipoPlantaCommon("Tomatera","Planta facil de cultivar")
tipo_planta_tomatera = TipoPlantaService.createFromCommon(db,tipo_planta_tomatera)
planta_mi_tomatera = PlantaCommon("Mi tomatera","Tomatera")
planta_mi_tomatera = PlantaService.createFromCommon(db,planta_mi_tomatera)
planta_mi_tomatera2 = PlantaCommon("Mi tomatera 2","Tomatera")
planta_mi_tomatera2 = PlantaService.createFromCommon(db,planta_mi_tomatera2)

sensor_humedad_maceta_1 = SensorService.create(db,TipoSensor.HUMEDAD,ZonaSensor.MACETA,1,"OTRO",patilla_0_lectura=20)

sensor_planta_1 = SensorPlantaService.createRelationFromCommon(db,sensor_humedad_ambiente_1,planta_mi_tomatera)
sensor_planta_2 = SensorPlantaService.createRelationFromCommon(db,sensor_temperatura_ambiente_1,planta_mi_tomatera)
sensor_planta_3 = SensorPlantaService.createRelationFromCommon(db,sensor_temperatura_y_humedad_ambiente_1,planta_mi_tomatera)

RegistroSensorService.create(db,TipoSensor.HUMEDAD,ZonaSensor.AMBIENTE,1,65.0, UnidadMedida.PORCENTAJE)
RegistroSensorService.create(db,TipoSensor.HUMEDAD,ZonaSensor.MACETA,1,65.0,UnidadMedida.PORCENTAJE)
RegistroSensorService.create(db,TipoSensor.TEMPERATURA,ZonaSensor.AMBIENTE,1,29.0,UnidadMedida.GRADOS_CENTIGRADOS)
RegistroSensorService.create(db,TipoSensor.TEMPERATURA,ZonaSensor.AMBIENTE,1,29.0,UnidadMedida.GRADOS_CENTIGRADOS)

# RegistroSensorService.createFromCommon(db,sensor_humedad_ambiente_1.crearRegistroSensor(75.0,UnidadMedida.PORCENTAJE))
# RegistroSensorService.createFromCommon(db,sensor_temperatura_ambiente_1.crearRegistroSensor(19.0,UnidadMedida.GRADOS_CENTIGRADOS))

# RegistroSensorService.createFromCommon(db,sensor_temperatura_y_humedad_ambiente_1.crearRegistroSensor(70.0,UnidadMedida.PORCENTAJE))
# RegistroSensorService.createFromCommon(db,sensor_temperatura_y_humedad_ambiente_1.crearRegistroSensor(22.0,UnidadMedida.GRADOS_CENTIGRADOS))

'''        
for reg in SensorService.listAll(db):
    print(str(reg))
for reg in PlantaService.listAll(db):
    print(str(reg))
for reg in TipoPlantaService.listAll(db):
    print(str(reg))
for reg in SensorPlantaService.listAll(db):
    print(str(reg))       
for reg in RegistroSensorService.listAll(db):
    print(str(reg))
'''

sensor_temperatura_y_humedad_ambiente_1.setPatillaLectura(24,0)
sensor_temperatura_y_humedad_ambiente_1.setPatillaLectura(25,1)
#sensor_temperatura_y_humedad_ambiente_1.setFechaEliminacion(datetime.now())
sensor_temperatura_y_humedad_ambiente_1 =SensorService.updateFromCommon(db,sensor_temperatura_y_humedad_ambiente_1)

sensor_temperatura_y_humedad_ambiente_1 =SensorService.unsubscribeFromCommon(db,sensor_temperatura_y_humedad_ambiente_1)

tipo_planta_tomatera.setDescripcionPlanta("Planta sencilla de cultivar")
tipo_planta_tomatera = TipoPlantaService.updateFromCommon(db,tipo_planta_tomatera)

sensor_planta_1.setFechaAnulacion(datetime.now())
sensor_planta_1 = SensorPlantaService.updateFromCommon(db,sensor_planta_1)

#planta_mi_tomatera2.setFechaMarchitacion(datetime.now())
#planta_mi_tomatera2 = PlantaService.updateFromCommon(db,planta_mi_tomatera2)

planta_mi_tomatera2 = PlantaService.unsubscribeFromCommon(db,planta_mi_tomatera2)

for reg in SensorService.listAll(db):
    print(str(reg))
print('*******************************************************************')   
for reg in SensorService.listAllActive(db):
    print(str(reg))
print('*******************************************************************')   
for reg in PlantaService.listAll(db):
    print(str(reg))
print('*******************************************************************')  
for reg in PlantaService.listAllActive(db):
    print(str(reg))
print('*******************************************************************')
for reg in PlantaService.listAllFromTypeFromCommon(db,tipo_planta_tomatera):
    print(str(reg))
print('*******************************************************************')  
for reg in PlantaService.listAllActiveFromTypeFromCommon(db,tipo_planta_tomatera):
    print(str(reg))
print('*******************************************************************')   
for reg in SensorPlantaService.listAll(db):
    print(str(reg))       
print('*******************************************************************')   
for reg in SensorPlantaService.listAllActive(db):
    print(str(reg))       
print('*******************************************************************')  
for reg in SensorPlantaService.listAllSensorsPlantFromCommon(db,planta_mi_tomatera):
    print(str(reg))
print('*******************************************************************')  
for reg in SensorPlantaService.listAllActiveSensorsPlantFromCommon(db,planta_mi_tomatera):
    print(str(reg))
print('*******************************************************************')
for reg in SensorPlantaService.listAllPlantsSensorFromCommon(db,sensor_temperatura_y_humedad_ambiente_1):
    print(str(reg))
print('*******************************************************************')  
for reg in SensorPlantaService.listAllActivePlantsSensorFromCommon(db,sensor_temperatura_y_humedad_ambiente_1):
    print(str(reg))

SensorPlantaService.unsubscribeAllFromSensorFromCommon(db,sensor_planta_2)
print('-------------------------------------------------------------------')  
for reg in SensorPlantaService.listAllPlantsSensorFromCommon(db,sensor_planta_2):
    print(str(reg))
print('*******************************************************************')  
for reg in SensorPlantaService.listAllActivePlantsSensorFromCommon(db,sensor_planta_2):
    print(str(reg))

SensorPlantaService.unsubscribeAllFromPlantFromCommon(db,planta_mi_tomatera)
print('-------------------------------------------------------------------')  
for reg in SensorPlantaService.listAllSensorsPlantFromCommon(db,planta_mi_tomatera):
    print(str(reg))
print('*******************************************************************')  
for reg in SensorPlantaService.listAllActiveSensorsPlantFromCommon(db,planta_mi_tomatera):
    print(str(reg))
  

'''
for reg in TipoPlantaService.listAll(db):
    print(str(reg))
for reg in RegistroSensorService.listAll(db):
    print(str(reg))    
for reg in SensorPlantaService.listAll(db):
    print(str(reg))       
for reg in SensorPlantaService.listAllSensorsPlant(db,planta_mi_tomatera.getNombrePlanta()):
    print(str(reg))

print(str(ModeloSensor.DHT11.getTipoSensor()))
print(str(ModeloSensor.DHT11.getZonaSensor()))
'''